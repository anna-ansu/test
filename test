stages:
  - test
  - build
  - deploy

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      variables:
        APP_ENV: test
        APP_DEBUG: 1
    - if: $CI_COMMIT_REF_NAME == "main"
      variables:
        APP_ENV: prod

phpunit:
  stage: test
  variables:
      ORACLE_RANDOM_PASSWORD: yes
  services: 
    - name: 
      alias: db,oracle
      entrypoint: [""]
      command: ["/bin/sh","-c","sleep 5 && cp /builds/$CI_PROJECT_PATH/tests/_data/init-oracle-full.sql /container-entrypoint-initdb.d/ && container-entrypoint.sh"]
  script:
      - composer validate --strict
      - composer install --no-scripts --prefer-dist --no-ansi --no-interaction --no-progress -n --optimize-autoloader
      - sleep 15
      - php vendor/bin/phpunit --colors=never --testsuite "Unit" --no-interaction --log-junit report.xml -d display_errors=on -d date.timezone="Etc/GMT-3"
  timeout: 5 minutes


build-js:
    image: node:18
    rules:
        -   if: $CI_PIPELINE_SOURCE == "merge_request_event"
        -   if: "$CI_OPEN_MERGE_REQUESTS"
        -   if: "$CI_COMMIT_BRANCH"

build-php:
    image: php:8-4
    dependencies:
        - build-js

# build-php:
#   script:
#     - composer install --no-scripts --prefer-dist --no-interaction --no-progress --no-dev --optimize-autoloader
#   artifacts:
#     expire_in: 1 hour
#     paths:
#       - vendor/

deploy:
  stage: deploy
  dependencies:
    - build-php
