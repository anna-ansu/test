include:
... test-phpunit, build-node11, build-php, docker

stages:
  - test
  - build-js
  - build
  - deploy


build-php:
  stage: build
  image: php
  services: 
    - name: база
  variables:
   ...
  dependencies:
      - build-js
  needs:
      - build-js
  script:
    ...


build-js:
  stage: build-js
  image: node
  script: 
...

docker-build:
    dependencies:
        - build-js
        - build-php
    needs:
        - build-js
        - build-php


deploy:
    stage: deploy
    script:
        - docker compose pull
        - docker compose up -d
    environment:
      name: ...
      url: ??
    rules:
      - if: $CI_COMMIT_BRANCH == "main"




отдельно в другом проекте для деплоя

include:
    -   component: docker-up-down
stages:
    - deploy

variables:
    ..
    DOCKER_IMAGE: "registry.ci.kk.cloud.ceb.loc/it.comfortcredit/bankrupts:$CI_COMMIT_BRANCH"
    
workflow:
...

up:
    environment:
        name: "$TAG"
    script:
        - docker compose pull
        - docker compose up ${SERVICES_NAME} -d
down:
    environment:
        name: "$TAG"


docker-compose.yml


version: "3.4"
services:
   image:
   environment:
networks:
            - traefik


labels:
- traefik.enable=true
...


